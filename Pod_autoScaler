O que iremos ver hoje?

Hoje é um dia particularmente fascinante! Vamos desbravar os territórios do Kubernetes, explorando a magia do Horizontal Pod Autoscaler (HPA),
uma ferramenta indispensável para quem almeja uma operação eficiente e resiliente. Portanto, afivelem os cintos e preparem-se para uma jornada de descobertas. 
A aventura #VAIIII começar! hahahha

===============================

Introdução ao Horizontal Pod Autoscaler (HPA)

O Horizontal Pod Autoscaler, carinhosamente conhecido como HPA, é uma das joias brilhantes incrustadas no coração do Kubernetes. Com o HPA, podemos ajustar automaticamente o número de réplicas de um conjunto de pods,
assegurando que nosso aplicativo tenha sempre os recursos necessários para performar eficientemente, sem desperdiçar recursos.
O HPA é como um maestro que, com a batuta das métricas, rege a orquestra de pods, 
assegurando que a harmonia seja mantida mesmo quando a sinfonia do tráfego de rede atinge seu crescendo.
Como o HPA Funciona?
O HPA é o olheiro vigilante que monitora as métricas dos nossos pods.
A cada batida do seu coração métrico, que ocorre em intervalos regulares,
ele avalia se os pods estão suando a camisa para atender às demandas ou se estão relaxando mais do que deveriam. Com base nessa avaliação,
ele toma a decisão sábia de convocar mais soldados para o campo de batalha ou de dispensar alguns para um merecido descanso.

Certamente! O Metrics Server é uma componente crucial para o funcionamento do Horizontal Pod Autoscaler (HPA), pois fornece as métricas necessárias para que o HPA tome decisões de escalonamento.
Vamos entender um pouco mais sobre o Metrics Server e como instalá-lo em diferentes ambientes Kubernetes, incluindo Minikube e KinD.

=========================================
Vamos primeramente instalar o metricserver para usarmos o HPA

Introdução ao Metrics Server

Antes de começarmos a explorar o Horizontal Pod Autoscaler (HPA), é essencial termos o Metrics Server instalado em nosso cluster Kubernetes. O Metrics Server é um agregador de métricas de recursos de sistema, que coleta métricas como uso de CPU e memória dos nós e pods no cluster. Essas métricas são vitais para o funcionamento do HPA, pois são usadas para determinar quando e como escalar os recursos.
Por que o Metrics Server é importante para o HPA?
O HPA utiliza métricas de uso de recursos para tomar decisões inteligentes sobre o escalonamento dos pods. Por exemplo, se a utilização da CPU de um pod exceder um determinado limite, o HPA pode decidir aumentar o número de réplicas desse pod. Da mesma forma, se a utilização da CPU for muito baixa, o HPA pode decidir reduzir o número de réplicas. Para fazer isso de forma eficaz, o HPA precisa ter acesso a métricas precisas e atualizadas, que são fornecidas pelo Metrics Server. Portanto, precisamos antes conhecer essa peça fundamental para o dia de hoje! :D
Instalando o Metrics Server
No Amazon EKS e na maioria dos clusters Kubernetes
Durante a nossa aula, estou com um cluster EKS, e para instalar o Metrics Server, podemos usar o seguinte comando:
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
Esse comando aplica o manifesto do Metrics Server ao seu cluster, instalando todos os componentes necessários.
No Minikube:
A instalação do Metrics Server no Minikube é bastante direta. Use o seguinte comando para habilitar o Metrics Server:
minikube addons enable metrics-server
Após a execução deste comando, o Metrics Server será instalado e ativado em seu cluster Minikube.
No KinD (Kubernetes in Docker):
Para o KinD, você pode usar o mesmo comando que usou para o EKS:
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
Verificando a Instalação do Metrics Server
Após a instalação do Metrics Server, é uma boa prática verificar se ele foi instalado corretamente e está funcionando como esperado. Execute o seguinte comando para obter a lista de pods no namespace kube-system e verificar se o pod do Metrics Server está em execução:
kubectl get pods -n kube-system | grep metrics-server
Obtendo Métricas
Com o Metrics Server em execução, agora você pode começar a coletar métricas de seu cluster. Aqui está um exemplo de como você pode obter métricas de uso de CPU e memória para todos os seus nodes:
kubectl top nodes
E para obter métricas de uso de CPU e memória para todos os seus pods:
kubectl top pods
Esses comandos fornecem uma visão rápida da utilização de recursos em seu cluster, o que é crucial para entender e otimizar o desempenho de seus aplicativos.



kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/high-availability-1.21+.yaml

k get pods -n kube-system
NAME                                           READY   STATUS    RESTARTS      AGE
coredns-6d4b75cb6d-dfmj6                       1/1     Running   0             58m
coredns-6d4b75cb6d-tqmrj                       1/1     Running   0             58m
etcd-obivas-control-plane                      1/1     Running   0             25h
kindnet-2r89m                                  1/1     Running   2 (25h ago)   7d
kindnet-5sd2z                                  1/1     Running   2             7d
kindnet-7zkrz                                  1/1     Running   2 (25h ago)   7d
kindnet-jdvwf                                  1/1     Running   2 (25h ago)   7d
kindnet-r2qxf                                  1/1     Running   2 (25h ago)   7d
kube-apiserver-obivas-control-plane            1/1     Running   0             25h
kube-controller-manager-obivas-control-plane   1/1     Running   8 (25h ago)   6d
kube-proxy-8f9rw                               1/1     Running   0             59m
kube-proxy-cc7g2                               1/1     Running   0             59m
kube-proxy-dvpgx                               1/1     Running   0             59m
kube-proxy-q7zqr                               1/1     Running   0             59m
kube-proxy-vgzst                               1/1     Running   0             59m
kube-scheduler-obivas-control-plane            1/1     Running   5 (25h ago)   6d
metrics-server-6c8776dd7f-td84s                1/1     Running   0             5m13s
metrics-server-6c8776dd7f-tp95r                1/1     Running   0             5m11s


kubectl top pods
NAME                               CPU(cores)   MEMORY(bytes)   
giropops-senhas-b887fccdc-gp7sd    1m           44Mi            
giropops-senhas-b887fccdc-np8pc    1m           45Mi            
giropops-senhas-b887fccdc-s58tb    1m           45Mi            
redis-deployment-764df994c-mwp98   2m           6Mi             
kubectl top nodes
NAME                   CPU(cores)   CPU(%)   MEMORY(bytes)   MEMORY(%)   
obivas-control-plane   63m          0%       935Mi           5%          
obivas-worker          16m          0%       293Mi           1%          
obivas-worker2         13m          0%       201Mi           1%          
obivas-worker3         16m          0%       273Mi           1%          
obivas-worker4         18m          0%       305Mi           1%          
